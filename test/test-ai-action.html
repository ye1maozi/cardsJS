<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>电脑AI行动测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .game-status {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .status-panel {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        .status-panel h3 {
            margin-top: 0;
            color: #333;
        }
        .status-item {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }
        .card-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 3px;
        }
        .card-item {
            padding: 5px;
            margin: 2px 0;
            background-color: white;
            border-radius: 3px;
            border-left: 3px solid #007bff;
        }
        .log-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 3px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
            border-bottom: 1px solid #eee;
        }
        .log-time {
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>电脑AI行动测试</h1>
        <p>此页面测试电脑AI的行动逻辑，验证AI是否能正常决策和使用卡牌。</p>
        
        <div class="test-section">
            <div class="test-title">1. 游戏状态</div>
            <div class="game-status">
                <div class="status-panel">
                    <h3>玩家状态</h3>
                    <div class="status-item">
                        <span>生命值:</span>
                        <span id="playerHealth">-</span>
                    </div>
                    <div class="status-item">
                        <span>能量:</span>
                        <span id="playerEnergy">-</span>
                    </div>
                    <div class="status-item">
                        <span>护甲:</span>
                        <span id="playerArmor">-</span>
                    </div>
                    <div class="status-item">
                        <span>手牌数量:</span>
                        <span id="playerHandCount">-</span>
                    </div>
                    <div class="status-item">
                        <span>牌组数量:</span>
                        <span id="playerDeckCount">-</span>
                    </div>
                </div>
                <div class="status-panel">
                    <h3>电脑状态</h3>
                    <div class="status-item">
                        <span>生命值:</span>
                        <span id="computerHealth">-</span>
                    </div>
                    <div class="status-item">
                        <span>能量:</span>
                        <span id="computerEnergy">-</span>
                    </div>
                    <div class="status-item">
                        <span>护甲:</span>
                        <span id="computerArmor">-</span>
                    </div>
                    <div class="status-item">
                        <span>手牌数量:</span>
                        <span id="computerHandCount">-</span>
                    </div>
                    <div class="status-item">
                        <span>牌组数量:</span>
                        <span id="computerDeckCount">-</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <div class="test-title">2. 电脑手牌</div>
            <div id="computerHandDisplay" class="card-list">
                <div class="card-item">等待加载...</div>
            </div>
        </div>
        
        <div class="test-section">
            <div class="test-title">3. AI测试控制</div>
            <button onclick="testAIDecision()">测试AI决策</button>
            <button onclick="testAITurn()">测试AI回合</button>
            <button onclick="simulateGameTime()">模拟游戏时间</button>
            <button onclick="resetGame()">重置游戏</button>
            <button onclick="clearLog()">清空日志</button>
            <div id="aiTestResult" class="test-result"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">4. 游戏日志</div>
            <div id="gameLog" class="log-container">
                <div class="log-entry">
                    <span class="log-time">[00:00]</span>
                    <span>测试开始...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入配置数据文件 -->
    <script src="../js/ConfigData.js"></script>
    
    <script>
        let gameState = null;
        let botPlayer = null;
        let gameTime = 0;
        let lastUpdateTime = Date.now();

        // 动态加载脚本
        async function loadScript(src) {
            return new Promise((resolve, reject) => {
                const existingScript = document.querySelector(`script[src="${src}"]`);
                if (existingScript) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // 初始化游戏
        async function initializeGame() {
            try {
                // 加载必要的脚本
                await loadScript('../js/Character.js');
                await loadScript('../js/CastingSystem.js');
                await loadScript('../js/Card.js');
                await loadScript('../js/CardConfig.js');
                await loadScript('../js/ConfigManager.js');
                await loadScript('../js/HeroSkill.js');
                await loadScript('../js/GameState.js');
                await loadScript('../js/BotPlayer.js');

                // 加载配置
                await ConfigManager.loadAllConfigs();
                await CardConfigManager.loadCardConfigs();

                // 创建游戏状态
                gameState = new GameState();
                await gameState.initializeDeck();
                gameState.dealInitialCards();

                // 创建AI
                botPlayer = new BotPlayer(gameState);

                addLog('游戏初始化完成');
                updateStatus();
                updateComputerHand();

            } catch (error) {
                addLog(`初始化失败: ${error.message}`, 'error');
            }
        }

        // 更新状态显示
        function updateStatus() {
            if (!gameState) return;

            // 玩家状态
            document.getElementById('playerHealth').textContent = gameState.playerHealth;
            document.getElementById('playerEnergy').textContent = gameState.playerEnergy;
            document.getElementById('playerArmor').textContent = gameState.playerArmor;
            document.getElementById('playerHandCount').textContent = gameState.playerHand.length;
            document.getElementById('playerDeckCount').textContent = gameState.playerDeck.length;

            // 电脑状态
            document.getElementById('computerHealth').textContent = gameState.computerHealth;
            document.getElementById('computerEnergy').textContent = gameState.computerEnergy;
            document.getElementById('computerArmor').textContent = gameState.computerArmor;
            document.getElementById('computerHandCount').textContent = gameState.computerHand.length;
            document.getElementById('computerDeckCount').textContent = gameState.computerDeck.length;
        }

        // 更新电脑手牌显示
        function updateComputerHand() {
            if (!gameState) return;

            const container = document.getElementById('computerHandDisplay');
            container.innerHTML = '';

            if (gameState.computerHand.length === 0) {
                container.innerHTML = '<div class="card-item">手牌为空</div>';
                return;
            }

            gameState.computerHand.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.className = 'card-item';
                cardElement.innerHTML = `
                    <strong>${card.name}</strong> (${card.class})<br>
                    消耗: ${card.energyCost} | 效果: ${card.effect}<br>
                    手牌索引: ${index}
                `;
                container.appendChild(cardElement);
            });
        }

        // 测试AI决策
        function testAIDecision() {
            if (!botPlayer) {
                showResult('AI未初始化', 'error');
                return;
            }

            try {
                addLog('开始测试AI决策...');
                
                // 更新游戏时间
                updateGameTime();
                
                // 执行AI决策
                const result = botPlayer.executeTurn();
                
                addLog(`AI决策结果: ${result}`);
                showResult(`AI决策成功\n结果: ${result}`, 'success');
                
                // 更新显示
                updateStatus();
                updateComputerHand();
                
            } catch (error) {
                addLog(`AI决策失败: ${error.message}`, 'error');
                showResult(`AI决策失败: ${error.message}`, 'error');
            }
        }

        // 测试AI回合
        function testAITurn() {
            if (!gameState) {
                showResult('游戏状态未初始化', 'error');
                return;
            }

            try {
                addLog('开始测试AI回合...');
                
                // 更新游戏时间
                updateGameTime();
                
                // 执行电脑回合
                const result = gameState.computerTurn();
                
                addLog(`AI回合结果: ${result}`);
                showResult(`AI回合成功\n结果: ${result}`, 'success');
                
                // 更新显示
                updateStatus();
                updateComputerHand();
                
            } catch (error) {
                addLog(`AI回合失败: ${error.message}`, 'error');
                showResult(`AI回合失败: ${error.message}`, 'error');
            }
        }

        // 模拟游戏时间
        function simulateGameTime() {
            if (!gameState) {
                showResult('游戏状态未初始化', 'error');
                return;
            }

            try {
                addLog('模拟游戏时间更新...');
                
                // 模拟时间流逝
                const currentTime = Date.now();
                const deltaTime = 3.5; // 模拟3.5秒
                
                // 更新游戏时间
                gameTime += deltaTime;
                gameState.gameTime = gameTime;
                gameState.lastUpdateTime = currentTime;
                
                addLog(`游戏时间更新: ${gameTime.toFixed(1)}s`);
                
                // 更新游戏状态
                gameState.update();
                
                // 检查是否触发抽牌
                const computerDrawInterval = gameState.computerCharacter.calculateDrawInterval(gameState.baseDrawInterval);
                const timeSinceLastDraw = gameTime - gameState.lastComputerDrawTime;
                
                addLog(`距离上次抽牌: ${timeSinceLastDraw.toFixed(1)}s, 抽牌间隔: ${computerDrawInterval.toFixed(1)}s`);
                
                if (timeSinceLastDraw >= computerDrawInterval) {
                    addLog('触发电脑抽牌和AI决策');
                    gameState.updateTimeBasedDrawing(currentTime);
                }
                
                showResult(`时间模拟成功\n当前时间: ${gameTime.toFixed(1)}s`, 'success');
                
                // 更新显示
                updateStatus();
                updateComputerHand();
                
            } catch (error) {
                addLog(`时间模拟失败: ${error.message}`, 'error');
                showResult(`时间模拟失败: ${error.message}`, 'error');
            }
        }

        // 重置游戏
        function resetGame() {
            if (!gameState) {
                showResult('游戏状态未初始化', 'error');
                return;
            }

            try {
                addLog('重置游戏...');
                
                gameState.reset();
                botPlayer = new BotPlayer(gameState);
                gameTime = 0;
                lastUpdateTime = Date.now();
                
                addLog('游戏重置完成');
                showResult('游戏重置成功', 'success');
                
                // 更新显示
                updateStatus();
                updateComputerHand();
                
            } catch (error) {
                addLog(`重置失败: ${error.message}`, 'error');
                showResult(`重置失败: ${error.message}`, 'error');
            }
        }

        // 更新游戏时间
        function updateGameTime() {
            const currentTime = Date.now();
            const deltaTime = (currentTime - lastUpdateTime) / 1000;
            lastUpdateTime = currentTime;
            gameTime += deltaTime;
            
            if (gameState) {
                gameState.gameTime = gameTime;
                gameState.lastUpdateTime = currentTime;
            }
        }

        // 显示结果
        function showResult(message, type = 'info') {
            const element = document.getElementById('aiTestResult');
            element.textContent = message;
            element.className = `test-result ${type}`;
        }

        // 添加日志
        function addLog(message, type = 'info') {
            const container = document.getElementById('gameLog');
            const time = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-time">[${time}]</span>
                <span>${message}</span>
            `;
            
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
        }

        // 清空日志
        function clearLog() {
            const container = document.getElementById('gameLog');
            container.innerHTML = '<div class="log-entry"><span class="log-time">[00:00]</span><span>日志已清空</span></div>';
        }

        // 页面加载完成后初始化
        window.addEventListener('load', () => {
            setTimeout(initializeGame, 100);
        });
    </script>
</body>
</html> 